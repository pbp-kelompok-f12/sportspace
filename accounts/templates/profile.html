{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="flex justify-center mt-10 px-6">
  <div class="bg-white/90 backdrop-blur-md shadow-md rounded-2xl p-8 w-full max-w-6xl text-[#0C2D57] grid grid-cols-1 md:grid-cols-3 gap-12">
    
    <!-- ========== LEFT COLUMN: PROFILE INFO ========== -->
    <div class="col-span-1 flex flex-col items-center md:items-start">
      <h3 class="text-2xl font-semibold mb-5 text-[#0C2D57] border-b-2 border-[#F87E18] pb-1 text-center md:text-left">
        Informasi Profil
      </h3>

      <div class="flex flex-col items-center text-center w-full">
        {% if profile.photo_url %}
          <img id="profile-photo" src="{{ profile.photo_url }}" alt="Foto Profil"
              class="h-28 w-28 rounded-full object-cover shadow-md border-4 border-[#0C2D57]/30 mb-3">
        {% else %}
          <img id="profile-photo" src="{% static 'img/defaultprofile.png' %}" alt="Default Foto"
              class="h-28 w-28 rounded-full object-cover shadow-md border-4 border-[#0C2D57]/30 mb-3">
        {% endif %}

        <h2 class="text-2xl font-bold text-[#0C2D57]">{{ request.user.username }}</h2>
        <p class="text-base text-gray-500 capitalize">{{ profile.role }}</p>

        <!-- Bio pengguna -->
        {% if profile.bio %}
          <p id="profile-bio" class="text-base italic text-gray-600 mt-2 max-w-xs">{{ profile.bio }}</p>
        {% else %}
          <p id="profile-bio" class="text-base italic text-gray-600 mt-2 max-w-xs"></p>
        {% endif %}
      </div>

      <!-- Informasi kontak -->
<div class="mt-6 w-full">
  <table class="text-lg w-full">
    <tr class="h-9">
      <td class="font-semibold w-36 align-top text-[#0C2D57]">Email</td>
      <td class="pr-2 text-[#0C2D57] text-lg">:</td>
      <td id="profile-email" class="text-[#0C2D57] font-medium text-lg">
        {{ profile.email|default:"-" }}
      </td>
    </tr>
    <tr class="h-9">
      <td class="font-semibold align-top text-[#0C2D57]">No. Telepon</td>
      <td class="text-[#0C2D57] text-lg">:</td>
      <td id="profile-phone" class="text-[#0C2D57] font-medium text-lg">
        {{ profile.phone|default:"-" }}
      </td>
    </tr>
    <tr class="h-9">
      <td class="font-semibold align-top text-[#0C2D57]">Alamat</td>
      <td class="text-[#0C2D57] text-lg">:</td>
      <td id="profile-address" class="text-[#0C2D57] font-medium text-lg leading-snug">
        {{ profile.address|default:"-" }}
      </td>
    </tr>
  </table>
</div>

      <!-- Tombol Edit -->
      <div class="mt-6 w-full flex justify-center text-center">
        <button id="edit-btn"
                class="bg-[#0C2D57] hover:bg-[#123872] text-white px-6 py-2 rounded-lg font-semibold transition">
          Ubah Profil
        </button>
      </div>


      <!-- Statistik -->

<div class="mt-10 w-full space-y-5 border-t border-[#0C2D57]/20 pt-6">
  <div class="flex justify-between items-center text-xl">
    <div class="flex items-center gap-1">
      <span class="font-semibold text-[#F87E18] w-48">Total Booking</span>
      <span class="text-[#0C2D57] text-lg">:</span>
    </div>
    <span class="font-bold text-right w-40 text-[#0C2D57]">{{ total_booking }}</span>
  </div>

  <div class="flex justify-between items-center text-xl">
    <div class="flex items-center gap-1">
      <span class="font-semibold text-[#F87E18] w-48">Rata-Rata Rating</span>
      <span class="text-[#0C2D57] text-lg">:</span>
    </div>
    <span class="font-bold text-right w-40 text-[#0C2D57]">{{ average_rating }}</span>
  </div>

  <div class="flex justify-between items-center text-xl">
    <div class="flex items-center gap-1">
      <span class="font-semibold text-[#F87E18] w-48">Bergabung</span>
      <span class="text-[#0C2D57] text-lg">:</span>
    </div>
    <span class="font-bold text-right w-40 text-[#0C2D57]">{{ joined_date }}</span>
  </div>
</div>



    </div>

    <!-- ========== RIGHT COLUMN: FRIEND LIST + REQUESTS ========== -->
    <div class="col-span-2 flex flex-col bg-white/70 shadow-inner rounded-xl p-6">
      <!-- Daftar Teman -->
      <div class="flex items-center justify-between mb-4">
        <h3 class="text-2xl font-semibold text-[#0C2D57]">Teman Saya (5)</h3>
        <button id="open-add-friend-btn"
                class="bg-[#F87E18] hover:bg-orange-600 text-white px-4 py-2 rounded-lg shadow transition font-semibold">
          Tambahkan Teman
        </button>
      </div>

      <div class="h-[400px] overflow-y-auto pr-2 space-y-4 no-scrollbar">
        {% for i in "12345" %}
        <div class="flex items-center bg-white shadow rounded-xl p-4 hover:scale-[1.01] transition">
          <img src="{% static 'img/defaultprofile.png' %}" 
               class="h-16 w-16 rounded-full object-cover border border-[#0C2D57]/30 mr-4">
          <div class="flex-grow">
            <p class="font-semibold text-[#0C2D57]">user{{ i }}</p>
            <p class="text-sm italic text-gray-500">"Teman padel tiap akhir pekan!"</p>
          </div>
          <div class="flex gap-2">
            <button class="text-sm bg-[#0C2D57] hover:bg-[#123872] text-white px-3.5 py-1.5 rounded-lg font-semibold transition w-24"
                    onclick="openChatModal('user{{ i }}')">Chat</button>
            <button class="text-sm bg-red-500 hover:bg-red-600 text-white px-3.5 py-1.5 rounded-lg font-semibold transition w-24"
                    onclick="confirmUnfriend('user{{ i }}')">Unfriend</button>
          </div>
        </div>
        {% endfor %}
      </div>

      <!-- Permintaan Pertemanan -->
      <div class="mt-10 border-t border-[#0C2D57]/10 pt-6">
        <h3 class="text-2xl font-semibold text-[#0C2D57] mb-4">Permintaan Pertemanan (2)</h3>
        <div class="space-y-3 max-h-[160px] overflow-y-auto pr-2 no-scrollbar">
          {% for i in "AB" %}
          <div class="flex items-center bg-white shadow rounded-xl p-4 hover:scale-[1.01] transition">
            <img src="{% static 'img/defaultprofile.png' %}" 
                 class="h-14 w-14 rounded-full object-cover border border-[#0C2D57]/30 mr-4">
            <div class="flex-grow">
              <p class="font-semibold text-[#0C2D57]">new_user{{ i }}</p>
              <p class="text-sm italic text-gray-500">"Ingin berteman denganmu!"</p>
            </div>
            <div class="flex gap-2">
              <button class="text-sm bg-[#0C2D57] hover:bg-[#123872] text-white px-3.5 py-1.5 rounded-lg font-semibold transition">
                Terima
              </button>
              <button class="text-sm bg-gray-300 hover:bg-gray-400 text-[#0C2D57] px-3.5 py-1.5 rounded-lg font-semibold transition">
                Tolak
              </button>
            </div>
          </div>
          {% endfor %}
        </div>
      </div>
    </div>
  </div>
  
</div>

<!-- ========== MODAL EDIT PROFIL========== -->
<div id="edit-modal"
     class="fixed inset-0 bg-black/40 backdrop-blur-sm hidden z-50 flex items-center justify-center">
  <div id="modal-content"
     class="bg-white rounded-xl p-6 w-full max-w-lg shadow-xl relative transform transition-all duration-500 ease-out scale-95 opacity-0">
    <button id="close-modal"
            class="absolute top-3 right-3 text-gray-500 hover:text-gray-800 text-xl">âœ•</button>
    <h3 class="text-xl font-semibold text-[#0C2D57] mb-4 text-center">Edit Profil</h3>

    <form id="edit-form" method="post" class="space-y-4 text-left">
      {% csrf_token %}
      {{ form.non_field_errors }}

      <div>
        <label class="block font-semibold text-[#F87E18] mb-1">Email</label>
        {{ form.email }}
      </div>
      <div>
        <label class="block font-semibold text-[#F87E18] mb-1">Nomor Telepon</label>
        {{ form.phone }}
      </div>
      <div>
        <label class="block font-semibold text-[#F87E18] mb-1">Alamat</label>
        {{ form.address }}
      </div>
      <div>
        <label class="block font-semibold text-[#F87E18] mb-1">Link Foto Profil</label>
        {{ form.photo_url }}
      </div>
      <div>
        <label class="block font-semibold text-[#F87E18] mb-1">Bio</label>
        {{ form.bio }}
      </div>

      <button type="submit"
        id="save-btn"
        class="w-full bg-[#0C2D57] hover:bg-[#123872] text-white font-semibold py-2 rounded-lg transition">
        Simpan Perubahan
      </button>
    </form>
  </div>
</div>

<!-- ========== MODAL CHAT ========== -->
<div id="chat-modal" class="fixed inset-0 bg-black/40 hidden z-50 flex items-center justify-center backdrop-blur-sm">
  <div id="chat-content"
       class="bg-white rounded-2xl shadow-lg relative transform transition-all duration-300 ease-out scale-95 opacity-0 w-full max-w-3xl">
    <div class="bg-[#0C2D57] text-white rounded-t-2xl px-6 py-4 flex justify-between items-center">
      <h3 class="text-2xl font-semibold">Chat dengan <span id="chat-username" class="text-[#F87E18]">User</span></h3>
      <button id="close-chat" class="text-gray-300 hover:text-white text-2xl">âœ•</button>
    </div>

    <div id="chat-box" class="bg-gray-100 rounded-b-2xl p-6 h-[500px] overflow-y-auto space-y-3">
      <div class="flex justify-start">
        <div class="bg-gray-300 text-[#0C2D57] rounded-xl px-3 py-2 max-w-[70%]">Halo! Gimana kabarnya?</div>
      </div>
      <div class="flex justify-end">
        <div class="bg-[#0C2D57] text-white rounded-xl px-3 py-2 max-w-[70%]">Baik banget, siap booking lagi ðŸ˜„</div>
      </div>
    </div>

    <div class="flex gap-2 border-t border-gray-300 p-4 bg-white rounded-b-2xl">
      <input id="chat-input" type="text" placeholder="Tulis pesan..." 
             class="flex-grow rounded-lg border border-gray-300 px-3 py-2 focus:outline-none focus:ring-1 focus:ring-[#0C2D57]">
      <button id="chat-send" 
              class="bg-[#F87E18] hover:bg-orange-600 text-white px-6 py-2 rounded-lg font-semibold transition">Kirim</button>
    </div>
  </div>
</div>

<!-- ========== MODAL UNFRIEND ========== -->
<div id="unfriend-modal" class="fixed inset-0 bg-black/40 hidden z-50 flex items-center justify-center backdrop-blur-sm">
  <div id="unfriend-content" 
       class="bg-white rounded-2xl p-6 w-full max-w-md shadow-lg relative transform transition-all duration-300 ease-out scale-95 opacity-0 text-center">
    <h3 class="text-2xl font-semibold text-[#0C2D57] mb-4">Hapus Teman?</h3>
    <p id="unfriend-message" class="text-gray-600 mb-6">Apakah kamu yakin ingin menghapus teman ini?</p>
    <div class="flex justify-center gap-4">
      <button id="cancel-unfriend" 
              class="bg-gray-300 hover:bg-gray-400 text-[#0C2D57] px-4 py-2 rounded-lg font-semibold transition">Batal</button>
      <button id="confirm-unfriend" 
              class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg font-semibold transition">Ya, Hapus</button>
    </div>
  </div>
</div>

<!-- ========== MODAL TAMBAH TEMAN ========== -->
<div id="add-friend-modal" class="fixed inset-0 bg-black/40 hidden z-50 flex items-center justify-center backdrop-blur-sm">
  <div id="add-friend-content" 
       class="bg-white rounded-2xl p-6 w-full max-w-2xl shadow-lg relative transform transition-all duration-300 ease-out scale-95 opacity-0">
    <button id="close-add-friend" class="absolute top-3 right-4 text-gray-500 hover:text-gray-800 text-xl">âœ•</button>
    <h3 class="text-2xl font-semibold text-[#0C2D57] mb-4 text-center">Tambahkan Teman</h3>

    <div class="flex gap-2 mb-5">
      <input id="friend-search-input" type="text" placeholder="Cari berdasarkan username..." 
             class="flex-grow rounded-lg border border-gray-300 px-3 py-2 focus:outline-none focus:ring-1 focus:ring-[#0C2D57]">
      <button id="friend-search-btn" 
              class="bg-[#0C2D57] hover:bg-[#123872] text-white px-4 py-2 rounded-lg font-semibold transition">Cari</button>
    </div>

    <div id="friend-search-result" class="mb-8 min-h-[80px] text-center">
      <p class="text-gray-400 italic">Ketik username dan tekan Cari.</p>
    </div>

    <div class="border-t border-gray-200 pt-4">
      <h4 class="text-lg font-semibold text-[#0C2D57] mb-3">Saran Teman</h4>
      <div id="suggestCarouselModal" class="flex overflow-x-auto scroll-smooth snap-x snap-mandatory no-scrollbar px-6">
        {% for i in "abcdefghijk" %}
        <div class="flex-none w-48 mx-2 bg-white shadow rounded-xl p-4 flex flex-col items-center text-center hover:scale-[1.03] transition snap-center">
          <img src="{% static 'img/defaultprofile.png' %}" 
               class="h-16 w-16 rounded-full object-cover border border-[#0C2D57]/30 mb-2">
          <p class="font-semibold text-[#0C2D57] text-sm">user{{ i }}</p>
          <p class="text-xs italic text-gray-500 mb-2">"Sering booking di BSD"</p>
          <button class="text-xs bg-[#F87E18] hover:bg-orange-600 text-white px-3 py-1 rounded-lg shadow font-semibold transition">Tambah</button>
        </div>
        {% endfor %}
      </div>
    </div>
  </div>
</div>

<div id="toast-container" class="fixed bottom-10 left-1/2 transform -translate-x-1/2 flex flex-col items-center space-y-2 z-[9999]"></div>



<script>
  // ======= TOAST FUNCTION =======
  function showToast(message, type = 'success') {
    const container = document.getElementById('toast-container');
    const toast = document.createElement('div');
    toast.classList.add('toast', type === 'success' ? 'toast-success' : 'toast-error');
    toast.textContent = message;

    container.appendChild(toast);
    setTimeout(() => toast.classList.add('show'), 10);
    setTimeout(() => {
      toast.classList.remove('show');
      setTimeout(() => toast.remove(), 400);
    }, 3000);
  }

  // ======= MODAL EDIT PROFIL =======
  const modal = document.getElementById('edit-modal');
  const modalContent = document.getElementById('modal-content');
  const openBtn = document.getElementById('edit-btn');
  const closeBtn = document.getElementById('close-modal');
  const form = document.getElementById('edit-form');
  const saveBtn = document.getElementById('save-btn');

  // Buka modal
  openBtn.addEventListener('click', () => {
    modal.classList.remove('hidden');
    setTimeout(() => {
      modalContent.classList.remove('scale-95', 'opacity-0');
      modalContent.classList.add('scale-100', 'opacity-100');
    }, 10);
  });

  // Tutup modal
  function closeEditModal() {
    modalContent.classList.add('scale-95', 'opacity-0');
    setTimeout(() => modal.classList.add('hidden'), 150);
  }

  closeBtn.addEventListener('click', closeEditModal);
  modal.addEventListener('click', (e) => { if (e.target === modal) closeEditModal(); });

  // Submit via AJAX
  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    saveBtn.textContent = "Menyimpan...";
    saveBtn.disabled = true;

    const formData = new FormData(form);
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

    try {
      const response = await fetch("", {
        method: "POST",
        headers: { "X-CSRFToken": csrfToken },
        body: formData
      });

      const data = await response.json();

      if (data.success) {
        document.getElementById('profile-email').textContent = data.email || "-";
        document.getElementById('profile-phone').textContent = data.phone || "-";
        document.getElementById('profile-address').textContent = data.address || "-";
        if (data.photo_url) document.getElementById('profile-photo').src = data.photo_url;
        if (data.bio !== undefined) document.getElementById('profile-bio').textContent = data.bio || "";

        closeEditModal();
        showToast(data.message || "Profil berhasil diperbarui!", 'success');
      } else {
        showToast("Terjadi kesalahan saat menyimpan data.", 'error');
      }
    } catch (err) {
      console.error(err);
      showToast("Gagal terhubung ke server.", 'error');
    }

    saveBtn.textContent = "Simpan Perubahan";
    saveBtn.disabled = false;
  });

  // ======= CHAT MODAL =======
  const chatModal = document.getElementById('chat-modal');
  const chatContent = document.getElementById('chat-content');
  const chatUsername = document.getElementById('chat-username');
  const closeChatBtn = document.getElementById('close-chat');

  function openChatModal(username) {
    chatUsername.textContent = username;
    chatModal.classList.remove('hidden');
    requestAnimationFrame(() => {
      chatContent.classList.remove('scale-95', 'opacity-0');
      chatContent.classList.add('scale-100', 'opacity-100');
    });
  }

  closeChatBtn.addEventListener('click', () => closeModal(chatModal, chatContent));
  chatModal.addEventListener('click', e => { if (e.target === chatModal) closeModal(chatModal, chatContent); });

  // ======= UNFRIEND MODAL =======
  const unfriendModal = document.getElementById('unfriend-modal');
  const unfriendContent = document.getElementById('unfriend-content');
  const cancelUnfriendBtn = document.getElementById('cancel-unfriend');
  const confirmUnfriendBtn = document.getElementById('confirm-unfriend');
  const unfriendMsg = document.getElementById('unfriend-message');
  let currentUserToUnfriend = null;

  function confirmUnfriend(username) {
    currentUserToUnfriend = username;
    unfriendMsg.textContent = `Apakah kamu yakin ingin menghapus ${username}?`;
    openModal(unfriendModal, unfriendContent);
  }

  cancelUnfriendBtn.addEventListener('click', () => closeModal(unfriendModal, unfriendContent));
  unfriendModal.addEventListener('click', e => { if (e.target === unfriendModal) closeModal(unfriendModal, unfriendContent); });
  confirmUnfriendBtn.addEventListener('click', () => {
    alert(`Teman '${currentUserToUnfriend}' berhasil dihapus (simulasi).`);
    closeModal(unfriendModal, unfriendContent);
  });

  // ======= TAMBAH TEMAN MODAL =======
  const addFriendModal = document.getElementById('add-friend-modal');
  const addFriendContent = document.getElementById('add-friend-content');
  document.getElementById('open-add-friend-btn').addEventListener('click', () => openModal(addFriendModal, addFriendContent));
  document.getElementById('close-add-friend').addEventListener('click', () => closeModal(addFriendModal, addFriendContent));

  // ======= FUNGSI BANTU =======
  function openModal(modal, content) {
    modal.classList.remove('hidden');
    requestAnimationFrame(() => {
      content.classList.remove('scale-95', 'opacity-0');
      content.classList.add('scale-100', 'opacity-100');
    });
  }

  function closeModal(modal, content) {
    content.classList.add('scale-95', 'opacity-0');
    setTimeout(() => modal.classList.add('hidden'), 150);
  }
</script>

{% endblock %}
