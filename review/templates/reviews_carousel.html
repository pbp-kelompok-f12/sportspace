{% load static %}
{% load review_extras %}
{% load rating_extras %}

<div class="p-8 border-t">
  <h2 class="text-2xl font-bold text-gray-800 mb-6">What they say?</h2>
  
  <!-- Carousel wrapper -->
  <div class="relative">
    <!-- Carousel inner -->
    <div id="reviewsCarousel" class="flex transition-transform duration-500 ease-in-out">
      {% for review in latest_reviews %}
      <div class="w-full md:w-1/2 flex-shrink-0 px-3">
        <div class="bg-gray-100 rounded-xl shadow p-5 h-full">
          <div class="flex items-center mb-3">
            {% if review.anonymous %}
              <img src="{% static 'img/default-avatar-icon.png' %}" alt="Anonymous"
                   class="h-10 w-10 rounded-full object-cover blur-sm" />
            {% else %}
              <img src="{{ review.user.profile.photo_url|default:'/static/img/default-avatar-icon.png' }}"
                   alt="{{ review.user.username }}" class="h-10 w-10 rounded-full object-cover" />
            {% endif %}
            <div class="ml-3">
              <p class="font-semibold text-gray-800">
                {% if review.anonymous %}
                  Anonymous
                {% else %}
                  {{ review.user.username }}
                {% endif %}
              </p>
              <p class="text-sm text-gray-500">{{ review.created_at|date:"M d, Y" }}</p>
            </div>
          </div>
          <p class="text-gray-700 mb-2">“{{ review.comment|truncatechars:120 }}”</p>
          <div class="flex items-center text-yellow-400">
            {% for i in "12345"|make_list %}
              {% if forloop.counter <= review.rating %}
                ★
              {% else %}
                <span class="text-gray-300">★</span>
              {% endif %}
            {% endfor %}
            <span class="ml-2 text-sm text-gray-600">{{ review.rating }}/5</span>
          </div>
        </div>
      </div>
      {% endfor %}
    </div>

    <!-- Prev/Next buttons -->
    <button id="prevBtn"
            class="absolute top-1/2 left-0 transform -translate-y-1/2 bg-white border rounded-full shadow p-2 hover:bg-gray-100">
      &#10094;
    </button>
    <button id="nextBtn"
            class="absolute top-1/2 right-0 transform -translate-y-1/2 bg-white border rounded-full shadow p-2 hover:bg-gray-100">
      &#10095;
    </button>
  </div>

  <!-- Link to all reviews -->
  <div class="mt-4 text-right">
    <a href="{% url 'review:all_reviews' venue.place_id %}" 
       class="text-blue-600 hover:underline font-medium">
      See all user reviews in one page
    </a>
  </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", function() {
  const carousel = document.getElementById("reviewsCarousel");
  const prevBtn = document.getElementById("prevBtn");
  const nextBtn = document.getElementById("nextBtn");

  let currentIndex = 0;
  const items = carousel.children;
  const totalItems = items.length;
  const itemsPerView = 2;

  function updateCarousel() {
    const offset = -(currentIndex * (100 / itemsPerView));
    carousel.style.transform = `translateX(${offset}%)`;
  }

  nextBtn.addEventListener("click", () => {
    if (currentIndex < Math.ceil(totalItems / itemsPerView) - 1) {
      currentIndex++;
      updateCarousel();
    }
  });

  prevBtn.addEventListener("click", () => {
    if (currentIndex > 0) {
      currentIndex--;
      updateCarousel();
    }
  });
});
</script>
