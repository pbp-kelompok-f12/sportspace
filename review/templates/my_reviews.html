{% extends 'base.html' %}
{% load static %}
{% load review_extras %}

{% block content %}
  <div class="max-w-3xl mx-auto py-10">
    <h2 class="text-3xl font-bold text-white mb-6">My Reviews</h2>

    {% if reviews %}
      <!-- Show user's reviews -->
      <div class="space-y-4 mb-10">
        {% for r in reviews %}
          <div class="bg-white rounded-lg shadow p-5 mb-4">
            <div class="flex items-center mb-3">
              <!-- Avatar -->
              {% if r.anonymous %}
                {% if r.user.profile.photo_url %}
                  <img src="{{ r.user.profile.photo_url }}" alt="Anonymous" class="h-10 w-10 rounded-full object-cover blur-sm" />
                {% else %}
                  <img src="{% static 'img/default-avatar-icon.png' %}" alt="Anonymous" class="h-10 w-10 rounded-full blur-sm" />
                {% endif %}
              {% else %}
                {% if r.user.profile.photo_url %}
                  <img src="{{ r.user.profile.photo_url }}" alt="{{ r.user.username }}" class="h-10 w-10 rounded-full object-cover" />
                {% else %}
                  <img src="{% static 'img/default-avatar-icon.png' %}" alt="{{ r.user.username }}" class="h-10 w-10 rounded-full" />
                {% endif %}
              {% endif %}

              <!-- Username -->
              <div class="ml-3">
                <p class="font-semibold text-gray-800">
                  {% if r.anonymous %}
                    {{ r.user.username|mask_username }}
                  {% else %}
                    {{ r.user.username }}
                  {% endif %}
                </p>

                <p class="text-sm text-gray-500">{{ r.lapangan.nama }}</p>
              </div>
            </div>

            <!-- Lapangan image -->
            <img src="{{ r.lapangan.thumbnail_url|default:'/static/img/no-image.png' }}" alt="{{ r.lapangan.nama }}" class="w-full h-40 object-cover rounded-md mb-3" />

            <!-- Rating stars -->
            <div class="flex items-center mb-2">
              {% for i in "12345" %}
                {% if forloop.counter <= r.rating %}
                  <span class="text-yellow-400">â˜…</span>
                {% else %}
                  <span class="text-gray-300">â˜…</span>
                {% endif %}
              {% endfor %}
              <span class="ml-2 text-sm text-gray-600">{{ r.rating }}/5</span>
            </div>

            <!-- Comment -->
            <p class="text-gray-700 mb-3">{{ r.comment }}</p>

            <!-- Timestamp -->
            <p class="text-sm text-gray-400">Reviewed at {{ r.created_at|date:'M d, Y H:i' }}</p>

            <!-- Edit/Delete buttons -->
            {% if r.user == request.user %}
              <div class="mt-3 flex gap-3">
                <a href="{% url 'review:edit_review' r.id %}" class="px-3 py-1 rounded bg-blue-500 text-white hover:bg-blue-600 text-sm">Edit</a>
                <a href="{% url 'review:delete_review' r.id %}" class="px-3 py-1 rounded bg-red-500 text-white hover:bg-red-600 text-sm" onclick="return confirm('Are you sure you want to delete this review?');">Delete</a>
              </div>
            {% endif %}
          </div>
        {% endfor %}
      </div>

      <!-- Add new review form -->
      {% if form %}
        <div class="bg-white shadow-lg rounded-lg p-6">
          <h3 class="text-xl font-semibold mb-4 text-gray-800">Write Another Review</h3>
          <form method="POST" class="space-y-5">
            {% csrf_token %}

            <!-- Lapangan dropdown -->
            <div>
              <label for="{{ form.lapangan.id_for_label }}" class="block text-sm font-medium text-gray-700">Choose Court</label>
              {{ form.lapangan }}
            </div>

            <!-- Comment -->
            <div>
              <label for="{{ form.comment.id_for_label }}" class="block text-sm font-medium text-gray-700">Your Comment</label>
              {{ form.comment }}
            </div>

            <!-- Anonymous -->
            <div class="flex items-center space-x-2">
              {{ form.anonymous }}
              <label for="{{ form.anonymous.id_for_label }}" class="text-gray-700">Post as Anonymous</label>
            </div>

            <button type="submit" class="bg-lime-600 hover:bg-lime-700 text-white px-5 py-2 rounded-md font-semibold">Submit Review</button>
          </form>
        </div>
      {% else %}
        <!-- Semua lapangan sudah direview -->
        <div class="bg-white shadow-lg rounded-lg p-6 text-center">
          <h3 class="text-xl font-semibold text-gray-800 mb-2">ðŸŽ‰ You have reviewed all courts!</h3>
          <p class="text-gray-600">Thanks for sharing your feedback on every court available in Sport Space.</p>
        </div>
      {% endif %}
    {% else %}
      <!-- No reviews yet -->
      <div class="bg-white rounded-lg shadow-lg p-8 text-center">
        <img src="{% static 'img/no-reviews1.png' %}" alt="No Reviews" class="h-40 mx-auto mb-6 opacity-80" />
        <h3 class="text-xl font-semibold text-gray-800 mb-2">You havenâ€™t written any reviews yet</h3>
        <p class="text-gray-600 mb-6">Pick a court and share your first review on Sport Space!</p>

        <!-- Add review form -->
        <form method="POST" class="space-y-5">
          {% csrf_token %}
          <div>
            <label for="{{ form.lapangan.id_for_label }}" class="block text-sm font-medium text-gray-700">Choose Court</label>
            {{ form.lapangan }}
          </div>
          <div>
            <label for="{{ form.comment.id_for_label }}" class="block text-sm font-medium text-gray-700">Your Comment</label>
            {{ form.comment }}
          </div>
          <div class="flex items-center justify-center space-x-2">
            {{ form.anonymous }}
            <label for="{{ form.anonymous.id_for_label }}" class="text-gray-700">Post as Anonymous</label>
          </div>
          <button type="submit" class="bg-lime-600 hover:bg-lime-700 text-white px-5 py-2 rounded-md font-semibold">Submit First Review</button>
        </form>
      </div>
    {% endif %}
  </div>
{% endblock %}
