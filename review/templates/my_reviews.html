{% extends 'base.html' %}
{% load static %}
{% load review_extras %}
{% load rating_extras %}

{% block content %}
  <div class="max-w-7xl mx-auto py-10 px-4 lg:px-0">
    <h2 class="text-3xl font-bold text-white mb-6">My Reviews</h2>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
      <!-- LEFT: Reviews List -->
      <div class="lg:col-span-2 space-y-6">
        {% if reviews %}
          <div class="grid grid-cols-1 sm:grid-cols-2 xl:grid-cols-3 gap-6">
            {% for r in reviews %}
              <div class="bg-white rounded-lg shadow overflow-hidden flex flex-col">
                <!-- Lapangan Image -->
                <img src="{{ r.lapangan.thumbnail_url|default:'/static/img/no-photo-venue.png' }}" alt="{{ r.lapangan.nama }}" class="h-40 w-full object-cover" />

                <div class="p-4 flex flex-col flex-grow">
                  <!-- Venue Name -->
                  <h3 class="text-lg font-bold text-blue-700 mb-1">{{ r.lapangan.nama }}</h3>

                  <!-- User Info -->
                  <div class="flex items-center mb-2">
                    {% if r.anonymous %}
                      <img src="{% static 'img/defaultprofile.png' %}" class="h-8 w-8 rounded-full blur-sm" alt="Anonymous" />
                    {% else %}
                      <img src="{{ r.user.profile.photo_url|default:'/static/img/defaultprofile.png' }}" class="h-8 w-8 rounded-full object-cover" alt="{{ r.user.username }}" />
                    {% endif %}
                    <div class="ml-2 text-sm">
                      <p class="font-semibold text-gray-800">
                        {% if r.anonymous %}
                          {{ r.user.username|mask_username }}
                        {% else %}
                          {{ r.user.username }}
                        {% endif %}
                      </p>
                      <p class="text-gray-500">Reviewed at {{ r.created_at|date:'M d, Y H:i' }}</p>
                    </div>
                  </div>

                  <!-- Rating -->
                  <div class="flex items-center mb-2">
                    {% for star in r.rating|star_types %}
                      {% if star == 'full' %}
                        <span class="text-yellow-400">★</span>
                      {% elif star == 'half' %}
                        <span class="relative text-gray-300">
                          ★
                          <span class="absolute left-0 top-0 w-1/2 overflow-hidden text-yellow-400">★</span>
                        </span>
                      {% else %}
                        <span class="text-gray-300">★</span>
                      {% endif %}
                    {% endfor %}
                    <span class="ml-2 text-sm text-gray-600">{{ r.rating }}/5</span>
                  </div>

                  <!-- Comment -->
                  <p class="text-gray-700 flex-grow">{{ r.comment }}</p>

                  <!-- Buttons -->
                  {% if r.user == request.user %}
                    <div class="mt-3 flex gap-2">
                      <button type="button" class="edit-btn flex-1 px-3 py-1 rounded bg-blue-500 text-white hover:bg-blue-600 text-sm" data-id="{{ r.id }}" data-comment="{{ r.comment|escapejs }}" data-anonymous="{{ r.anonymous }}">Edit</button>
                      <button type="button" class="delete-btn flex-1 px-3 py-1 rounded bg-red-500 text-white hover:bg-red-600 text-sm" data-id="{{ r.id }}">Delete</button>
                    </div>
                  {% endif %}
                </div>
              </div>
            {% endfor %}
          </div>
        {% else %}
          <div class="bg-white rounded-lg shadow-lg p-8 text-center">
            <img src="{% static 'img/no-reviews1.png' %}" alt="No Reviews" class="h-40 mx-auto mb-6 opacity-80" />
            <h3 class="text-xl font-semibold text-gray-800 mb-2">You haven’t written any reviews yet</h3>
            <p class="text-gray-600">Pick a court and share your first review on Sport Space!</p>
          </div>
        {% endif %}
      </div>

      <!-- RIGHT: Add Review Form -->
      <div class="bg-white rounded-xl shadow-lg p-8 self-start sticky top-6">
        <h3 class="text-2xl font-bold text-gray-800 mb-6">✍️ Write a Review</h3>
        <form method="POST" class="space-y-5">
          {% csrf_token %}
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Choose Court</label>
            {{ form.lapangan }}
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Your Comment</label>
            {{ form.comment }}
          </div>
          <div class="flex items-center space-x-2">
            {{ form.anonymous }}
            <label class="text-gray-700">Post as Anonymous</label>
          </div>
          <button type="submit" class="w-full bg-green-600 hover:bg-green-700 text-white px-5 py-3 rounded-lg font-semibold">Submit Review</button>
        </form>
      </div>
    </div>
  </div>

<!-- Modal Edit -->
<div id="editModal" class="hidden fixed inset-0 flex items-center justify-center bg-black bg-opacity-60 z-50">
  <div class="bg-gradient-to-b from-white to-gray-100 rounded-xl shadow-2xl w-[28rem] p-6 relative">
    <button type="button" id="closeEditBtn" 
            class="absolute top-3 right-3 text-purple-600 hover:text-purple-800 text-xl">✖</button>
    <h2 class="text-2xl font-bold mb-4 text-gray-800">Edit Review</h2>
    <form id="editReviewForm" class="space-y-4">
      <textarea id="editComment" 
                class="w-full border rounded-lg p-3 
                       focus:ring-2 focus:ring-blue-400 
                       text-gray-800 bg-white"></textarea>
      <label class="flex items-center space-x-2 text-gray-800">
        <input type="checkbox" id="editAnonymous" class="rounded">
        <span>Post as Anonymous</span>
      </label>
      <div class="flex justify-end gap-3">
        <button type="button" id="cancelEditBtn" class="bg-gray-400 px-4 py-2 rounded-lg text-white">Cancel</button>
        <button type="submit" class="bg-green-600 hover:bg-green-700 px-4 py-2 rounded-lg text-white">Save</button>
      </div>
    </form>
  </div>
</div>

  <!-- Modal Delete -->
  <div id="deleteModal" class="hidden fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 z-50">
    <div class="bg-white rounded-lg shadow-lg w-80 p-6 text-center">
      <h2 class="text-lg font-bold mb-4">Delete Review?</h2>
      <p class="mb-4">This action cannot be undone.</p>
      <div class="flex justify-center gap-2">
        <button id="cancelDeleteBtn" class="bg-gray-400 px-3 py-1 rounded">Cancel</button>
        <button id="confirmDeleteBtn" class="bg-red-600 text-white px-3 py-1 rounded">Delete</button>
      </div>
    </div>
  </div>
{% endblock %}

{% block scripts %}
  <script>
    let currentReviewId = null
    const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value
    
    function openEditModal(id, comment, anonymous) {
      currentReviewId = id
      document.getElementById('editComment').value = comment
      document.getElementById('editAnonymous').checked = anonymous === 'True' || anonymous === true
      document.getElementById('editModal').classList.remove('hidden')
    }
    
    function closeEditModal() {
      document.getElementById('editModal').classList.add('hidden')
    }
    
    function openDeleteModal(id) {
      currentReviewId = id
      document.getElementById('deleteModal').classList.remove('hidden')
    }
    
    function closeDeleteModal() {
      document.getElementById('deleteModal').classList.add('hidden')
    }
    
    // Event listeners tombol edit & delete
    document.querySelectorAll('.edit-btn').forEach((btn) => {
      btn.addEventListener('click', () => {
        openEditModal(btn.dataset.id, btn.dataset.comment, btn.dataset.anonymous)
      })
    })
    
    document.querySelectorAll('.delete-btn').forEach((btn) => {
      btn.addEventListener('click', () => {
        openDeleteModal(btn.dataset.id)
      })
    })
    
    // Close modal
    document.getElementById('closeEditBtn').addEventListener('click', closeEditModal)
    document.getElementById('cancelEditBtn').addEventListener('click', closeEditModal)
    document.getElementById('cancelDeleteBtn').addEventListener('click', closeDeleteModal)
    
    // Submit edit
    document.getElementById('editReviewForm').addEventListener('submit', async (e) => {
      e.preventDefault()
      const comment = document.getElementById('editComment').value
      const anonymous = document.getElementById('editAnonymous').checked
    
      const res = await fetch(`/review/edit/${currentReviewId}/`, {
        method: 'POST',
        headers: {
          'X-CSRFToken': csrftoken,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ comment, anonymous })
      })
      if (res.ok) location.reload()
    })
    
    // Confirm delete
    document.getElementById('confirmDeleteBtn').addEventListener('click', async () => {
      const res = await fetch(`/review/delete/${currentReviewId}/`, {
        method: 'POST',
        headers: { 'X-CSRFToken': csrftoken }
      })
      if (res.ok) location.reload()
    })
  </script>
{% endblock %}
