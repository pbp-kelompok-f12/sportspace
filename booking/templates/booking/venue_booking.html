{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="min-h-screen bg-gradient-to-b from-[#0024F] to-[#0069C0]">
    <!-- Main Content Card -->
    <div class="max-w-6xl mx-auto p-6">
        <div class="bg-white rounded-2xl shadow-xl overflow-hidden">
            
            <!-- Facility Information -->
            <div class="flex flex-col md:flex-row">
                <!-- Left: Court Image -->
                <div class="md:w-1/2">
                    <img src="{% if venue.image_url %}{{ venue.image_url }}{% else %}{% static 'img/default-court.jpg' %}{% endif %}" 
                         alt="{{ venue.name }}" 
                         class="w-full h-64 md:h-96 object-cover rounded-l-2xl">
                </div>
                
                <!-- Right: Facility Details -->
                <div class="md:w-1/2 p-8 flex flex-col justify-center">
                    <h1 class="text-3xl font-bold text-orange-500 mb-2">{{ venue.name }}</h1>
                    <p class="text-gray-600 mb-4">{{ venue.location }}</p>
                    <button 
                        class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors"
                        onclick="window.scrollBy({ top: 500, left: 0, behavior: 'smooth' });">
                        Book Below!
                    </button>
                </div>
            </div>
            
            <!-- Date Selection -->
            <div class="p-8 border-t">
                <h2 class="text-2xl font-bold text-gray-800 mb-6">Pilih Hari</h2>
                <div class="flex items-center gap-4 overflow-x-auto">
                    {% for date_option in date_options %}
                    <a href="?date={{ date_option.date }}" 
                       class="px-4 py-2 rounded-lg whitespace-nowrap transition-colors {% if date_option.date == selected_date %}bg-blue-600 text-white{% elif date_option.is_today %}bg-green-100 text-green-800 border border-green-300{% else %}bg-gray-200 text-gray-700 hover:bg-gray-300{% endif %}">
                        {% if date_option.is_today %}Hari Ini{% else %}{{ date_option.display }}{% endif %}
                    </a>
                    {% endfor %}
                </div>
                <p class="text-sm text-gray-500 mt-2">Booking hanya bisa untuk 7 hari kedepan</p>
            </div>
            
            <!-- Time Slot Selection -->
            <div class="p-8 border-t">
                <h2 class="text-2xl font-bold text-gray-800 mb-6">Pilih Waktu</h2>
                <p class="text-sm text-gray-500 mb-4">Waktu saat ini: {{ now|date:"d M Y H:i" }} WIB</p>
                <div class="grid grid-cols-3 gap-4">
                    {% for slot in time_slots %}
                    <button class="time-slot-btn p-4 rounded-lg border-2 transition-all duration-200 {% if slot.is_unavailable %}bg-gray-300 border-gray-400 cursor-not-allowed{% else %}bg-gray-100 border-gray-300 hover:bg-blue-100 hover:border-blue-400{% endif %}"
                            {% if slot.is_unavailable %}disabled{% endif %}
                            data-start-time="{{ slot.start|date:'H:i' }}"
                            data-end-time="{{ slot.end|date:'H:i' }}">
                        <div class="text-sm text-gray-500 mb-1">{{ selected_date }}</div>
                        <div class="font-semibold text-lg text-green-900">{{ slot.display }}</div>
                        <div class="text-sm {% if slot.is_past %}text-red-500{% elif slot.is_booked %}text-gray-500{% else %}text-green-600{% endif %}">
                            {% if slot.is_past %}Melewati Waktu{% elif slot.is_booked %}Tidak Tersedia{% else %}Tersedia{% endif %}
                        </div>
                    </button>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Booking Modal -->
<div id="bookingModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
    <div class="flex items-center justify-center min-h-screen p-4 overflow-y-auto">
        <div class="bg-white rounded-2xl p-4 md:p-8 max-w-md w-full max-h-[90vh] overflow-y-auto">
            <h3 class="text-xl md:text-2xl font-bold text-gray-800 mb-4 md:mb-6">Konfirmasi Booking</h3>
            
            <div class="mb-4 md:mb-6">
                <h4 class="font-semibold text-gray-700 text-sm md:text-base">{{ venue.name }}</h4>
                <p class="text-gray-600 text-sm">{{ venue.location }}</p>
                <p class="text-blue-600 font-semibold text-sm md:text-base" id="selectedTime"></p>
            </div>
            
            <form id="bookingForm">
                {% csrf_token %}
                <input type="hidden" id="venueId" value="{{ venue.id }}">
                <input type="hidden" id="bookingDate" value="{{ selected_date }}">
                <input type="hidden" id="startTime" name="start_time">
                <input type="hidden" id="endTime" name="end_time">
                
                <div class="space-y-3 md:space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1 md:mb-2">Nama Lengkap</label>
                        <input type="text" name="customer_name" required 
                               class="w-full px-3 md:px-4 py-2 md:py-3 border border-gray-300 rounded-lg text-gray-900 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-sm md:text-base">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1 md:mb-2">Email</label>
                        <input type="email" name="customer_email" required 
                               class="w-full px-3 md:px-4 py-2 md:py-3 border border-gray-300 rounded-lg text-gray-900 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-sm md:text-base">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1 md:mb-2">Nomor Telepon</label>
                        <input type="tel" name="customer_phone" required 
                               class="w-full px-3 md:px-4 py-2 md:py-3 border border-gray-300 rounded-lg text-gray-900 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-sm md:text-base">
                    </div>
                    
                    <!-- Mock Payment Info -->
                    <div class="border-t pt-3 md:pt-4">
                        <h4 class="font-semibold text-gray-700 mb-2 md:mb-3 text-sm md:text-base">Informasi Pembayaran (Mockup)</h4>
                        <div class="space-y-2 md:space-y-3">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1 md:mb-2">Nomor Kartu</label>
                                <input type="text" placeholder="1234 5678 9012 3456" 
                                       class="w-full px-3 md:px-4 py-2 md:py-3 border border-gray-300 rounded-lg text-gray-900 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-sm md:text-base">
                            </div>
                            <div class="grid grid-cols-2 gap-2 md:gap-3">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1 md:mb-2">MM/YY</label>
                                    <input type="text" placeholder="12/25" 
                                           class="w-full px-3 md:px-4 py-2 md:py-3 border border-gray-300 rounded-lg text-gray-900 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-sm md:text-base">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1 md:mb-2">CVV</label>
                                    <input type="text" placeholder="123" 
                                           class="w-full px-3 md:px-4 py-2 md:py-3 border border-gray-300 rounded-lg text-gray-900 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-sm md:text-base">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="flex flex-col md:flex-row gap-2 md:gap-3 mt-6 md:mt-8">
                    <button type="button" id="cancelBooking" 
                            class="flex-1 px-4 md:px-6 py-2 md:py-3 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 text-sm md:text-base">
                        Batal
                    </button>
                    <button type="submit" 
                            class="flex-1 px-4 md:px-6 py-2 md:py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 text-sm md:text-base">
                        Konfirmasi Booking
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Check for success message from previous booking
    const successMessage = sessionStorage.getItem('booking_success');
    if (successMessage) {
        showToast(successMessage, 'success');
        sessionStorage.removeItem('booking_success');
    }
    
    const timeSlotBtns = document.querySelectorAll('.time-slot-btn:not([disabled])');
    const modal = document.getElementById('bookingModal');
    const selectedTimeEl = document.getElementById('selectedTime');
    const startTimeInput = document.getElementById('startTime');
    const endTimeInput = document.getElementById('endTime');
    const bookingForm = document.getElementById('bookingForm');
    const cancelBtn = document.getElementById('cancelBooking');
    
    // Handle time slot selection
    timeSlotBtns.forEach(btn => {
        btn.addEventListener('click', function() {
            // Only allow clicking if not disabled
            if (this.disabled) return;
            
            const startTime = this.dataset.startTime;
            const endTime = this.dataset.endTime;
            
            selectedTimeEl.textContent = `${startTime} - ${endTime}`;
            startTimeInput.value = startTime;
            endTimeInput.value = endTime;
            
            modal.classList.remove('hidden');
        });
    });
    
    // Handle modal close
    cancelBtn.addEventListener('click', function() {
        modal.classList.add('hidden');
    });
    
    // Handle form submission
    bookingForm.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const formData = new FormData(this);
        const data = {
            venue_id: document.getElementById('venueId').value,
            booking_date: document.getElementById('bookingDate').value,
            start_time: formData.get('start_time'),
            end_time: formData.get('end_time'),
            customer_name: formData.get('customer_name'),
            customer_email: formData.get('customer_email'),
            customer_phone: formData.get('customer_phone')
        };
        
        fetch('{% url "booking:create_booking" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                modal.classList.add('hidden');
                // Store the success message in sessionStorage to show after refresh
                sessionStorage.setItem('booking_success', data.message);
                // Refresh the page to update time slot availability
                window.location.reload();
            } else {
                showToast(data.message, 'error');
            }
        })
        .catch(error => {
            showToast('Terjadi kesalahan', 'error');
        });
    });
    
});
</script>
{% endblock %}